<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>個人資料管理</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      padding: 20px;
    }

    .container {
      max-width: 400px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    input[readonly] {
      background: #eee;
    }

    .avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      margin: 0 auto 10px;
      display: block;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>個人資料</h2>

    <!-- 頭像預覽 -->
    <img id="avatarPreview" class="avatar-preview" src="https://via.placeholder.com/100?text=頭像" alt="頭像預覽" />

    <!-- 頁面1 -->
    <div id="page1" class="page active">
      <label for="avatarUpload">上傳頭像</label>
      <input type="file" id="avatarUpload" accept="image/*" />

      <label for="identity">身分</label>
      <input id="identity" type="text" readonly />

      <label for="combinedClass">班級</label>
      <input id="combinedClass" type="text" readonly />

      <label for="name">姓名</label>
      <input id="name" type="text" />

      <label for="studentId">學號</label>
      <input id="studentId" type="text" readonly />

    </div>

    <!-- 頁面2 -->
    <div id="page2" class="page">
      <label for="email">電子郵件</label>
      <input id="email" type="email" readonly />

      <label for="oldPassword">舊密碼</label>
      <input type="password" id="oldPassword" />

      <label for="newPassword">新密碼</label>
      <input type="password" id="newPassword" />

      <label for="confirmPassword">確認新密碼</label>
      <input type="password" id="confirmPassword" />
    </div>

    <div class="buttons">
      <button id="prevBtn" disabled>上一頁</button>
      <button id="nextBtn">下一頁</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const pages = document.querySelectorAll('.page');
      let currentPage = 0;

      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      // 用來儲存 class_id 後續更新用
      window.classId = null;

      function showPage(index) {
        pages.forEach((page, i) => page.classList.toggle('active', i === index));
        prevBtn.disabled = index === 0;
        nextBtn.textContent = index === pages.length - 1 ? '完成' : '下一頁';
      }

      // 載入用戶資料
      fetch('/api/profile')
        .then(res => {
          if (!res.ok) throw new Error('無法取得用戶資料');
          return res.json();
        })
        .then(data => {
          if (!data.success) throw new Error(data.message || '取得資料失敗');
          const user = data.user;

          // 頭像 - 假設後端有avatar_url欄位，沒的話用placeholder
          document.getElementById('avatarPreview').src = user.avatar_url || 'https://via.placeholder.com/100?text=頭像';

          // 身分轉換 (和你後端 role_map 對應)
          const roleMap = {
            "student": "學生",
            "teacher": "教師",
            "director": "主任",
            "ta": "科助",
            "admin": "管理員"
          };
          document.getElementById('identity').value = roleMap[user.role] || '';

          // 班級顯示 & 存 class_id
          if (user.classes && user.classes.length > 0) {
            document.getElementById('combinedClass').value = user.classes
              .map(c => (c.department.replace("管科", "") + c.name))
              .join("、");
          } else {
            document.getElementById('combinedClass').value = user.class_display_name || '';
          }
          window.classId = user.class_id || null;

          document.getElementById('name').value = user.name || '';
          document.getElementById('studentId').value = user.username || '';
          document.getElementById('email').value = user.email || '';
        })
        .catch(err => alert(err.message));

      prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage--;
          showPage(currentPage);
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentPage < pages.length - 1) {
          currentPage++;
          showPage(currentPage);
        } else {
          // 完成按鈕，送出資料

          const avatarFile = document.getElementById('avatarUpload').files[0];

          // 上傳頭像（如果有）
          function uploadAvatar() {
            if (!avatarFile) return Promise.resolve(null);

            const formData = new FormData();
            formData.append('avatar', avatarFile);

            return fetch('/api/upload_avatar', {
              method: 'POST',
              body: formData,
            })
              .then(res => res.json())
              .then(data => {
                if (!data.success) throw new Error(data.message || '頭像上傳失敗');
                return data.avatar_url; // 回傳頭像URL
              });
          }

          uploadAvatar()
            .then(avatarUrl => {
              // 更新個人資料
              const payload = {
                username: document.getElementById('studentId').value,
                role: document.getElementById('identity').value,
                name: document.getElementById('name').value,
                class_id: window.classId,
              };

              return fetch('/api/saveProfile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              })
                .then(res => res.json())
                .then(data => {
                  if (!data.success) throw new Error(data.message || '更新個人資料失敗');
                  return avatarUrl;
                });
            })
            .then(() => {
              // 變更密碼（如果有填）
              const oldPwd = document.getElementById('oldPassword').value.trim();
              const newPwd = document.getElementById('newPassword').value.trim();
              const confirmPwd = document.getElementById('confirmPassword').value.trim();

              if (oldPwd || newPwd || confirmPwd) {
                if (newPwd !== confirmPwd) {
                  alert('新密碼與確認新密碼不符！');
                  throw new Error('密碼確認失敗');
                }
                return fetch('/api/change_password', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ old_password: oldPwd, new_password: newPwd }),
                })
                  .then(res => res.json())
                  .then(data => {
                    if (!data.success) throw new Error(data.message || '變更密碼失敗');
                    alert('資料及密碼更新成功！');
                  });
              } else {
                alert('資料更新成功！');
              }
            })
            .catch(err => alert(err.message));
        }
      });

      // 頭像預覽功能
      document.getElementById('avatarUpload').addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = event => {
            document.getElementById('avatarPreview').src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      showPage(currentPage);
    });
  </script>
</body>

</html>