<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>用戶管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .table thead th {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h2 class="mb-3">用戶管理</h2>
        <div class="d-flex gap-2 mb-3 flex-wrap">
            <input type="text" id="searchUsername" class="form-control w-auto" placeholder="搜尋帳號">
            <button class="btn btn-primary" onclick="searchUsers()">搜尋</button>
            <button class="btn btn-secondary" onclick="resetSearch()">重置</button>
            <button class="btn btn-success ms-auto" onclick="openCreateModal()">新增用戶</button>
        </div>
        <table class="table table-bordered table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>帳號</th>
                    <th>姓名</th>
                    <th>Email</th>
                    <th>角色</th>
                    <th>所屬班級</th>
                    <th>科系</th>
                    <th>帶班</th>
                    <th>建立時間</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>

    <!-- 編輯用戶 Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">編輯用戶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label class="form-label">帳號</label>
                            <input type="text" id="editUsername" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">姓名</label>
                            <input type="text" id="editName" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="editEmail" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">角色</label>
                            <select id="editRole" class="form-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">新密碼 (如不修改可留空)</label>
                            <input type="password" id="editPassword" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定學生班級 Modal -->
    <div class="modal fade" id="assignStudentClassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">設定學生班級</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="assignStudentId">
                    <div class="mb-3">
                        <label class="form-label">選擇班級</label>
                        <select id="assignStudentClassSelect" class="form-select"></select>
                    </div>
                    <button class="btn btn-primary" onclick="submitAssignStudentClass()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定教師/主任帶班 Modal -->
    <div class="modal fade" id="assignTeacherClassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">設定帶班</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="assignTeacherId">
                    <div class="mb-3">
                        <label class="form-label">身分</label>
                        <select id="assignTeacherRole" class="form-select">
                            <option value="班導師">班導師</option>
                            <option value="授課教師">授課教師</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">選擇班級</label>
                        <select id="assignTeacherClassSelect" class="form-select"></select>
                    </div>
                    <button class="btn btn-primary" onclick="submitAssignTeacherClass()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增用戶 Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增用戶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label class="form-label">帳號</label>
                            <input type="text" id="createUsername" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">密碼</label>
                            <input type="password" id="createPassword" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">姓名</label>
                            <input type="text" id="createName" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="createEmail" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">角色</label>
                            <select id="createRole" class="form-select" required>
                                <option value="student">學生</option>
                                <option value="teacher">教師</option>
                                <option value="director">主任</option>
                                <option value="ta">科助</option>
                                <option value="admin">管理員</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">新增</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const roleMap = {
            student: '學生',
            teacher: '教師',
            director: '主任',
            ta: '科助',
            admin: '管理員'
        };

        async function loadUsers() {
            try {
                const res = await fetch('/admin/api/get_all_users');
                const data = await res.json();
                if (!data.success) {
                    alert("載入失敗：" + data.message);
                    return;
                }

                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = "";

                data.users.forEach(user => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.name || ''}</td>
                        <td>${user.email || ''}</td>
                        <td>${roleMap[user.role] || user.role}</td>
                        <td>${user.role === 'student' ? (user.class_name || '-') : '-'}</td>
                        <td>${user.role === 'student' ? (user.department || '-') : '-'}</td>
                        <td>${['teacher', 'director'].includes(user.role) ? (user.teaching_classes || '-') : '-'}</td>
                        <td>${user.created_at || ''}</td>
                        <td>
                          <button class="btn btn-sm btn-warning" onclick="openEditModal(${user.id}, '${user.username}', '${user.name || ''}', '${user.email || ''}', '${user.role}', '${user.class_id || ''}')">編輯</button>
                          <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">刪除</button>
                          ${user.role === 'student' ? `<button class="btn btn-sm btn-outline-primary" onclick="openAssignStudentClass(${user.id})">設定班級</button>` : ''}
                          ${['teacher', 'director'].includes(user.role) ? `<button class="btn btn-sm btn-outline-secondary" onclick="openAssignTeacherClass(${user.id})">設定帶班</button>` : ''}
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("載入用戶錯誤：", err);
                alert("載入用戶失敗");
            }
        }

        async function searchUsers() {
            const username = document.getElementById('searchUsername').value.trim();

            const params = new URLSearchParams();
            if (username) params.append('username', username);

            const res = await fetch('/admin/api/search_users?' + params.toString());
            const data = await res.json();
            if (!data.success) { alert('搜尋失敗'); return; }

            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            data.users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.name || ''}</td>
                    <td>${user.email || ''}</td>
                    <td>${roleMap[user.role] || user.role}</td>
                    <td>${user.role === 'student' ? (user.class_name || '-') : '-'}</td>
                    <td>${user.role === 'student' ? (user.department || '-') : '-'}</td>
                    <td>${['teacher', 'director'].includes(user.role) ? (user.teaching_classes || '-') : '-'}</td>
                    <td>${user.created_at || ''}</td>
                    <td>
                      <button class="btn btn-sm btn-warning" onclick="openEditModal(${user.id}, '${user.username}', '${user.name || ''}', '${user.email || ''}', '${user.role}', '${user.class_id || ''}')">編輯</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">刪除</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function resetSearch() {
            document.getElementById('searchUsername').value = '';
            loadUsers();
        }

        function openCreateModal() {
            const roleSelect = document.getElementById('createRole');
            const classGroup = document.getElementById('createClassIdGroup');
            roleSelect.addEventListener('change', () => {
                classGroup.style.display = roleSelect.value === 'student' ? '' : 'none';
            });
            roleSelect.dispatchEvent(new Event('change'));
            new bootstrap.Modal(document.getElementById('createUserModal')).show();
        }

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                username: document.getElementById('createUsername').value,
                password: document.getElementById('createPassword').value,
                name: document.getElementById('createName').value,
                email: document.getElementById('createEmail').value,
                role: document.getElementById('createRole').value,
                class_id: document.getElementById('createClassId').value || null
            };
            const res = await fetch('/admin/api/create_user', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                loadUsers();
            }
        });

        // 打開編輯 Modal
        function openEditModal(id, username, name, email, role, classId) {
            const roleSelect = document.getElementById('editRole');
            const classIdInput = document.getElementById('editClassId');
            const classIdGroup = classIdInput.closest('.mb-3');

            roleSelect.innerHTML = '';

            if (role === 'teacher' || role === 'director') {
                roleSelect.disabled = false;
                ['teacher', 'director'].forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    opt.textContent = roleMap[r];
                    if (r === role) opt.selected = true;
                    roleSelect.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.value = role;
                opt.textContent = roleMap[role] || role;
                opt.selected = true;
                roleSelect.appendChild(opt);
                roleSelect.disabled = true;
            }

            if (role === 'student') {
                classIdGroup.style.display = '';
                classIdInput.value = classId || '';
            } else {
                classIdGroup.style.display = 'none';
                classIdInput.value = '';
            }

            document.getElementById('editUserId').value = id;
            document.getElementById('editUsername').value = username;
            document.getElementById('editName').value = name;
            document.getElementById('editEmail').value = email;
            document.getElementById('editPassword').value = "";

            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        // 編輯用戶送出
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editUserId').value;
            const payload = {
                username: document.getElementById('editUsername').value,
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value,
                password: document.getElementById('editPassword').value,
                class_id: document.getElementById('editClassId').value || null
            };

            const res = await fetch(`/admin/api/update_user/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            alert(data.message);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadUsers();
            }
        });

        // 刪除用戶
        async function deleteUser(id) {
            if (!confirm("確定要刪除這個用戶嗎？")) return;

            const res = await fetch(`/admin/api/delete_user/${id}`, { method: 'DELETE' });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                loadUsers();
            }
        }

        document.addEventListener('DOMContentLoaded', loadUsers);

        async function loadClasses(selectEl) {
            const res = await fetch('/admin/api/get_all_classes');
            const data = await res.json();
            if (!data.success) { alert('載入班級失敗'); return; }
            selectEl.innerHTML = '';
            data.classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.department || ''} ${c.name}`.trim();
                selectEl.appendChild(opt);
            });
        }

        function openAssignStudentClass(userId) {
            document.getElementById('assignStudentId').value = userId;
            const sel = document.getElementById('assignStudentClassSelect');
            loadClasses(sel);
            new bootstrap.Modal(document.getElementById('assignStudentClassModal')).show();
        }

        async function submitAssignStudentClass() {
            const user_id = document.getElementById('assignStudentId').value;
            const class_id = document.getElementById('assignStudentClassSelect').value;
            const res = await fetch('/admin/api/assign_student_class', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id, class_id }) });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('assignStudentClassModal')).hide();
                loadUsers();
            }
        }

        function openAssignTeacherClass(userId) {
            document.getElementById('assignTeacherId').value = userId;
            const sel = document.getElementById('assignTeacherClassSelect');
            const roleSel = document.getElementById('assignTeacherRole');
            loadClasses(sel);
            roleSel.value = '班導師';
            new bootstrap.Modal(document.getElementById('assignTeacherClassModal')).show();
        }

        async function submitAssignTeacherClass() {
            const teacher_id = document.getElementById('assignTeacherId').value;
            const class_id = document.getElementById('assignTeacherClassSelect').value;
            const role = document.getElementById('assignTeacherRole').value;
            const res = await fetch('/admin/api/assign_class_teacher', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ teacher_id, class_id, role }) });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('assignTeacherClassModal')).hide();
                loadUsers();
            }
        }
    </script>
</body>

</html>